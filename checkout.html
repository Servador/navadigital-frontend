<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout - NavaDigital Shop</title>
  <link rel="stylesheet" href="style.css" />

  <style>
  /* ====== Checkout Box ====== */
  .checkout-container {
    max-width: 420px;
    margin: 40px auto;
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
  }

  .checkout-container h2 {
    text-align: center;
    margin-bottom: 15px;
  }

  .checkout-container input,
  .checkout-container select {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 6px;
  }

  #payBtn {
    width: 100%;
    background: #111;
    color: #fff;
    border: none;
    padding: 10px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    margin-top: 5px;
  }

  #payBtn:hover {
    background: #333;
  }

  /* ====== Popup Overlay ====== */
  .popup {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.65);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
  }

  .popup.hidden {
    display: none;
  }

  /* ====== Popup Box ====== */
  .popup-content {
    background: #fff;
    padding: 24px 20px;
    border-radius: 14px;
    width: 90%;
    max-width: 400px;
    text-align: center;
    position: relative;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
  }

  .close {
    position: absolute;
    right: 12px;
    top: 8px;
    cursor: pointer;
    font-size: 22px;
  }

  /* ====== QR Image (QRIS) ====== */
  .qr-img {
    display: block;
    width: 240px;
    height: 240px;
    margin: 14px auto 10px auto;
    object-fit: contain;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  /* ====== Rekening Transfer ====== */
  .bank-box {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 12px 14px;
    text-align: left;
    margin: 10px 0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .bank-box:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
  }

  .bank-box b {
    display: block;
    font-size: 15px;
    color: #000;
    margin-bottom: 5px;
  }

  .bank-box span {
    font-size: 14px;
    color: #333;
    line-height: 1.4;
    display: block;
  }

  .bank-box small {
    font-size: 12px;
    color: #777;
    display: block;
    margin-top: 4px;
  }

  /* ====== Timer Text ====== */
  #timer {
    font-weight: bold;
    color: #e53935;
    margin-top: 6px;
  }
  .bank-box span {
  display: block;
  font-size: 15px;
  font-weight: 500;
  color: #111;
}

.bank-box div {
  font-size: 13px;
  color: #555;
  margin-top: 2px;
}
</style>

</head>
<body>
  <div class="checkout-wrapper">
    <div id="checkoutBox" class="checkout-container">
      <h2>Checkout</h2>
      <p><b>Produk:</b> <span id="productName"></span></p>
      <p><b>Paket:</b> <span id="productPackage"></span></p>

      <input type="text" id="buyerName" placeholder="Nama Lengkap (wajib diisi)">
      <input type="text" id="buyerContact" placeholder="Nomor WhatsApp (wajib diisi)">
      <select id="methodSelect">
  <option value="QRIS">QRIS</option>
  <option value="GoPay">GoPay</option>
  <option value="SeaBank">SeaBank</option>
  <option value="BCA">BCA Transfer</option>
  <option value="Jago">Bank Jago</option>
</select>

      <button id="payBtn">Buat Pesanan & Tampilkan QR</button>
    </div>
  </div>

  <div id="qrPopup" class="popup hidden">
    <div class="popup-content">
      <span id="closeQR" class="close">√ó</span>
      <h3>‚Äî QRIS ALL PAYMENT ‚Äî</h3>
      <p id="timer"></p>
      <img src="img/qris.jpeg" alt="QRIS" class="qr-img">
      <p id="summary"></p>
      <p id="priceDetail"></p>
      <p id="uniqueCode"></p>
      <button id="doneBtn" class="done-btn">‚úÖ Tandai Lunas</button>
    </div>
  </div>

  <div class="footer">
    <button onclick="window.location='index.html'" class="home-btn">Home</button>
  </div>

  <script>
const API_BASE = "https://navadigitall-production-8933.up.railway.app";
const data = JSON.parse(localStorage.getItem("checkoutData"));

document.getElementById("productName").textContent = data.productName ?? "-";
document.getElementById("productPackage").textContent = data.variantTitle ?? "-";

let timerInterval;
let timeLeft = 600;

function startTimer() {
  timerInterval = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timerInterval);
      document.getElementById("timer").innerText = "‚ùå Waktu habis!";
      return;
    }
    const m = String(Math.floor(timeLeft / 60)).padStart(2,"0");
    const s = String(timeLeft % 60).padStart(2,"0");
    document.getElementById("timer").innerText = `Waktu pembayaran: ${m}:${s}`;
  }, 1000);
}

document.getElementById("payBtn").addEventListener("click", async () => {
  const name = buyerName.value.trim();
  const contact = buyerContact.value.trim();
  const method = document.getElementById("methodSelect").value;
  const btn = document.getElementById("payBtn");

  if (!name || !contact) return alert("‚ö† Nama & nomor WhatsApp wajib diisi!");

  btn.disabled = true;
  btn.innerHTML = "‚è≥ Memproses pesanan...";

  const kodeUnik = Math.floor(100 + Math.random() * 900);
  const total = Number(data.price) + kodeUnik;

  document.getElementById("summary").innerHTML =
    `<b>${data.productName}</b> ‚Äî ${data.variantTitle}`;
  document.getElementById("priceDetail").innerHTML =
    `Total Bayar: <b>Rp ${total.toLocaleString("id-ID")}</b>`;
  document.getElementById("uniqueCode").innerHTML =
    `Kode Unik: <b>${kodeUnik}</b>`;

  const qrImg = document.querySelector(".qr-img");
  const qrBox = document.querySelector(".popup-content");
  qrBox.querySelectorAll(".bank-box").forEach(e => e.remove());

  if (method === "QRIS") {
    qrImg.src = "img/qris.jpeg";
    qrImg.style.display = "block";
  } else {
    qrImg.style.display = "none";
    const bankList = [];

    // normalisasi agar tidak case sensitive
const methodNormalized = method.toLowerCase();

if (methodNormalized === "seabank" || methodNormalized === "all") {
  bankList.push({
    title: "üè¶ SEA BANK",
    info: "SeaBank ‚Äî 901922960772 (a.n. Muhammad Faiz Rizqi)"
  });
}

if (methodNormalized === "gopay" || methodNormalized === "all") {
  bankList.push({
    title: "üì± GOPAY",
    info: "GoPay ‚Äî 0821-2983-7460 (a.n. Muhammad Faiz Rizqi)"
  });
}

if (methodNormalized === "bca" || methodNormalized === "all") {
  bankList.push({
    title: "üè¶ BCA",
    info: "BCA ‚Äî 6050649502 (a.n. Muhammad Faiz Rizqi)"
  });
}

if (methodNormalized === "jago" || methodNormalized === "all") {
  bankList.push({
    title: "üè¶ BANK JAGO",
    info: "Bank Jago ‚Äî 105686282051 (a.n. Muhammad Faiz Rizqi)"
  });
}

    // buat tiap kotak rekening
    bankList.forEach(b => {
      const div = document.createElement("div");
      div.className = "bank-box";
      div.innerHTML = `
  <b>${b.title}</b>
  <span>${b.info.split("(")[0].trim()}</span>
  <div style="font-size:13px;color:#555;margin-top:2px;">
    ${b.info.match(/\(a\.n\.[^)]+\)/)?.[0] || ""}
  </div>
  <small style="display:block;margin-top:6px;color:#777;">
    Pastikan transfer sesuai total di atas
  </small>
`;
      qrBox.appendChild(div);
    });
  }

  localStorage.setItem("orderPayment", JSON.stringify({
    productId: data.productId,
    variantId: data.variantId,
    nameBuyer: name,
    contact,
    method,
    total
  }));

  document.getElementById("checkoutBox").classList.add("hidden");
  document.getElementById("qrPopup").classList.remove("hidden");
  startTimer();

  btn.disabled = false;
  btn.innerHTML = "Buat Pesanan & Tampilkan QR";
});

document.getElementById("closeQR").onclick = () =>
  document.getElementById("qrPopup").classList.add("hidden");

document.getElementById("doneBtn").onclick = async () => {
  const pay = JSON.parse(localStorage.getItem("orderPayment"));
  if (!pay) return alert("Data pesanan tidak ditemukan!");

  try {
    const res = await fetch(`${API_BASE}/api/orders`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        product_id: pay.productId,
        variant_id: pay.variantId,
        name: pay.nameBuyer,
        contact: pay.contact,
        method: pay.method,
        total: pay.total
      })
    });

    const result = await res.json();
    if (!result.id) return alert("‚ùå Gagal menyimpan pesanan!");

    localStorage.setItem("lastOrderId", result.id);
    localStorage.removeItem("orderPayment");
    localStorage.removeItem("checkoutData");

    window.location.href = "success.html";
  } catch (e) {
    console.error(e);
    alert("‚ö† Gagal menghubungi server!");
  }
};
</script>

</body>
</html>
